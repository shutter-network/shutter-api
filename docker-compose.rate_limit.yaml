### docker compose overrides for rate limiting
#
# Usage:
#   add the override via `-f docker-compose.rate_limit.yaml`, e.g.:
#   ```
#   docker compose -f docker-compose.yml -f docker-compose.rate_limit.yaml up -d
#   ```
#
# Note: the custom caddy container needs to be build before use:
#
#   ```
#   docker compose -f docker-compose.yml -f docker-compose.rate_limit.yaml build caddy
#   ```
#
# Management of API keys for premium access via the `apikeys` script in `./apikeys/apikeys.py`.
# See script header for documentation!

services:
  compiler:
    image: ghcr.io/astral-sh/uv:python3.13-alpine
    volumes:
      - ./apikeys/apikeys.py:/apikeys.py
      - ${DATA_DIR:-./data}:/data
    environment:
      - KEYS_FILE=/data/keys.csv
      - CADDY_SNIPPET=/data/apikeys.caddy
    command: uv run --script /apikeys.py --compile
  shutter-api:
    labels:
      # /check_authentication endpoint
      caddy.@checkauth.path_0: "/check_authentication"
      caddy.@checkauth.path_1: "/api/check_authentication"
      caddy.handle: "@checkauth"
      caddy.handle.handle_0: "@withApiKey"
      caddy.handle.handle_0.respond: "`{\"result\": \"authenticated\"}`"
      caddy.handle.handle_1: "@noApiKey"
      caddy.handle.handle_1.respond: "`{\"result\": \"unauthenticated\"}`"

      ## Redirects from old endpoints to new ones (308 Permanent Redirect - preserves HTTP method and request body):
      # /api/register_event_identity -> /api/event/register_identity
      caddy.@redirect_register_event_identity.path: "/api/register_event_identity*"
      caddy.@redirect_register_event_identity.method: POST
      caddy.handle_redirect_register_event_identity: "@redirect_register_event_identity"
      caddy.handle_redirect_register_event_identity.redir: "/api/event/register_identity 308"

      # /api/register_identity -> /api/time/register_identity
      caddy.@redirect_register_identity.path: "/api/register_identity*"
      caddy.@redirect_register_identity.method: POST
      caddy.handle_redirect_register_identity: "@redirect_register_identity"
      caddy.handle_redirect_register_identity.redir: "/api/time/register_identity 308"

      # /api/get_data_for_encryption -> /api/time/get_data_for_encryption
      # Note: This redirects to time-based by default.
      caddy.@redirect_get_data_for_encryption.path: "/api/get_data_for_encryption*"
      caddy.@redirect_get_data_for_encryption.method: GET
      caddy.handle_redirect_get_data_for_encryption: "@redirect_get_data_for_encryption"
      caddy.handle_redirect_get_data_for_encryption.redir: "/api/time/get_data_for_encryption{query} 308"

      # /api/compile_event_trigger_definition -> /api/event/compile_trigger_definition
      caddy.@redirect_compile_event_trigger_definition.path: "/api/compile_event_trigger_definition*"
      caddy.@redirect_compile_event_trigger_definition.method: POST
      caddy.handle_redirect_compile_event_trigger_definition: "@redirect_compile_event_trigger_definition"
      caddy.handle_redirect_compile_event_trigger_definition.redir: "/api/event/compile_trigger_definition 308"

      # /api/get_decryption_key -> /api/time/get_decryption_key
      caddy.@redirect_get_decryption_key.path: "/api/get_decryption_key*"
      caddy.@redirect_get_decryption_key.method: GET
      caddy.handle_redirect_get_decryption_key: "@redirect_get_decryption_key"
      caddy.handle_redirect_get_decryption_key.redir: "/api/time/get_decryption_key{query} 308"

      # /api/get_event_trigger_expiration_block -> /api/event/get_trigger_expiration_block
      caddy.@redirect_get_event_trigger_expiration_block.path: "/api/get_event_trigger_expiration_block*"
      caddy.@redirect_get_event_trigger_expiration_block.method: GET
      caddy.handle_redirect_get_event_trigger_expiration_block: "@redirect_get_event_trigger_expiration_block"
      caddy.handle_redirect_get_event_trigger_expiration_block.redir: "/api/event/get_trigger_expiration_block{query} 308"

      # /api/get_event_decryption_key -> /api/event/get_decryption_key
      caddy.@redirect_get_event_decryption_key.path: "/api/get_event_decryption_key*"
      caddy.@redirect_get_event_decryption_key.method: GET
      caddy.handle_redirect_get_event_decryption_key: "@redirect_get_event_decryption_key"
      caddy.handle_redirect_get_event_decryption_key.redir: "/api/event/get_decryption_key{query} 308"

      ## Rate limiting:
      # Make sure to mount compiled 'apikeys' file to this path in caddy container:
      caddy.import: /etc/caddy/apikeys
      caddy.handle_errors: 429
      caddy.handle_errors.respond: "`{\"error\": \"Request is rate limited. See documentation! https://github.com/shutter-network/shutter-api?tab=readme-ov-file#rate-limits--authorization\", \"retry_after_seconds\": {http.response.header.Retry-After}, \"status\": {err.status_code}}`"
      caddy.handle_errors.header.Content-type: "application/json"

      # Rate limits unauthorized
      caddy.rate_limit_0: "@noApiKey"
      caddy.rate_limit_0.log_key: " "

      caddy.rate_limit_0.zone_0: register_identity__unauthorized
      caddy.rate_limit_0.zone_0.key: "{remote_host}"
      caddy.rate_limit_0.zone_0.events: 5
      caddy.rate_limit_0.zone_0.window: 1d
      caddy.rate_limit_0.zone_0.match.path: "*/time/register_identity*"
      caddy.rate_limit_0.zone_0.match.method: POST

      caddy.rate_limit_0.zone_1: get_data_for_encryption__unauthorized
      caddy.rate_limit_0.zone_1.key: "{remote_host}"
      caddy.rate_limit_0.zone_1.events: 10
      caddy.rate_limit_0.zone_1.window: 1d
      caddy.rate_limit_0.zone_1.match.path: "*/time/get_data_for_encryption*"
      caddy.rate_limit_0.zone_1.match.method: GET

      caddy.rate_limit_0.zone_2: get_decryption_key__unauthorized
      caddy.rate_limit_0.zone_2.key: "{remote_host}"
      caddy.rate_limit_0.zone_2.events: 20
      caddy.rate_limit_0.zone_2.window: 1d
      caddy.rate_limit_0.zone_2.match.path: "*/time/get_decryption_key*"
      caddy.rate_limit_0.zone_2.match.method: GET

      caddy.rate_limit_0.zone_3: decrypt_commitment__unauthorized
      caddy.rate_limit_0.zone_3.key: "{remote_host}"
      caddy.rate_limit_0.zone_3.events: 10
      caddy.rate_limit_0.zone_3.window: 1d
      caddy.rate_limit_0.zone_3.match.path: "*/decrypt_commitment*"
      caddy.rate_limit_0.zone_3.match.method: GET

      caddy.rate_limit_0.zone_4: compile_event_trigger_definition__unauthorized
      caddy.rate_limit_0.zone_4.key: "{remote_host}"
      caddy.rate_limit_0.zone_4.events: 20
      caddy.rate_limit_0.zone_4.window: 1d
      caddy.rate_limit_0.zone_4.match.path: "*/event/compile_trigger_definition*"
      caddy.rate_limit_0.zone_4.match.method: POST

      caddy.rate_limit_0.zone_5: register_event_identity__unauthorized
      caddy.rate_limit_0.zone_5.key: "{remote_host}"
      caddy.rate_limit_0.zone_5.events: 5
      caddy.rate_limit_0.zone_5.window: 1d
      caddy.rate_limit_0.zone_5.match.path: "*/event/register_identity*"
      caddy.rate_limit_0.zone_5.match.method: POST

      caddy.rate_limit_0.zone_6: get_event_trigger_expiration_block__unauthorized
      caddy.rate_limit_0.zone_6.key: "{remote_host}"
      caddy.rate_limit_0.zone_6.events: 20
      caddy.rate_limit_0.zone_6.window: 1d
      caddy.rate_limit_0.zone_6.match.path: "*/event/get_trigger_expiration_block*"
      caddy.rate_limit_0.zone_6.match.method: GET

      caddy.rate_limit_0.zone_7: get_event_decryption_key__unauthorized
      caddy.rate_limit_0.zone_7.key: "{remote_host}"
      caddy.rate_limit_0.zone_7.events: 20
      caddy.rate_limit_0.zone_7.window: 1d
      caddy.rate_limit_0.zone_7.match.path: "*/event/get_decryption_key*"
      caddy.rate_limit_0.zone_7.match.method: GET

      caddy.rate_limit_0.zone_8: event_get_data_for_encryption__unauthorized
      caddy.rate_limit_0.zone_8.key: "{remote_host}"
      caddy.rate_limit_0.zone_8.events: 10
      caddy.rate_limit_0.zone_8.window: 1d
      caddy.rate_limit_0.zone_8.match.path: "*/event/get_data_for_encryption*"
      caddy.rate_limit_0.zone_8.match.method: GET

      # Rate limits with api key
      caddy.rate_limit_1: "@withApiKey"
      caddy.rate_limit_1.log_key: " "

      caddy.rate_limit_1.zone_0: register_identity__authorized
      caddy.rate_limit_1.zone_0.key: "{header.Authorization}"
      caddy.rate_limit_1.zone_0.events: 500
      caddy.rate_limit_1.zone_0.window: 1d
      caddy.rate_limit_1.zone_0.match.path: "*/time/register_identity*"
      caddy.rate_limit_1.zone_0.match.method: POST

      caddy.rate_limit_1.zone_1: get_data_for_encryption__authorized
      caddy.rate_limit_1.zone_1.key: "{header.Authorization}"
      caddy.rate_limit_1.zone_1.events: 1000
      caddy.rate_limit_1.zone_1.window: 1d
      caddy.rate_limit_1.zone_1.match.path: "*/time/get_data_for_encryption*"
      caddy.rate_limit_1.zone_1.match.method: GET

      caddy.rate_limit_1.zone_2: get_decryption_key__authorized
      caddy.rate_limit_1.zone_2.key: "{header.Authorization}"
      caddy.rate_limit_1.zone_2.events: 2000
      caddy.rate_limit_1.zone_2.window: 1d
      caddy.rate_limit_1.zone_2.match.path: "*/time/get_decryption_key*"
      caddy.rate_limit_1.zone_2.match.method: GET

      caddy.rate_limit_1.zone_3: decrypt_commitment__authorized
      caddy.rate_limit_1.zone_3.key: "{header.Authorization}"
      caddy.rate_limit_1.zone_3.events: 1000
      caddy.rate_limit_1.zone_3.window: 1d
      caddy.rate_limit_1.zone_3.match.path: "*/decrypt_commitment*"
      caddy.rate_limit_1.zone_3.match.method: GET

      caddy.rate_limit_1.zone_4: compile_event_trigger_definition__authorized
      caddy.rate_limit_1.zone_4.key: "{header.Authorization}"
      caddy.rate_limit_1.zone_4.events: 2000
      caddy.rate_limit_1.zone_4.window: 1d
      caddy.rate_limit_1.zone_4.match.path: "*/event/compile_trigger_definition*"
      caddy.rate_limit_1.zone_4.match.method: POST

      caddy.rate_limit_1.zone_5: register_event_identity__authorized
      caddy.rate_limit_1.zone_5.key: "{header.Authorization}"
      caddy.rate_limit_1.zone_5.events: 500
      caddy.rate_limit_1.zone_5.window: 1d
      caddy.rate_limit_1.zone_5.match.path: "*/event/register_identity*"
      caddy.rate_limit_1.zone_5.match.method: POST

      caddy.rate_limit_1.zone_6: get_event_trigger_expiration_block__authorized
      caddy.rate_limit_1.zone_6.key: "{header.Authorization}"
      caddy.rate_limit_1.zone_6.events: 2000
      caddy.rate_limit_1.zone_6.window: 1d
      caddy.rate_limit_1.zone_6.match.path: "*/event/get_trigger_expiration_block*"
      caddy.rate_limit_1.zone_6.match.method: GET

      caddy.rate_limit_1.zone_7: get_event_decryption_key__authorized
      caddy.rate_limit_1.zone_7.key: "{header.Authorization}"
      caddy.rate_limit_1.zone_7.events: 2000
      caddy.rate_limit_1.zone_7.window: 1d
      caddy.rate_limit_1.zone_7.match.path: "*/event/get_decryption_key*"
      caddy.rate_limit_1.zone_7.match.method: GET

      caddy.rate_limit_1.zone_8: event_get_data_for_encryption__authorized
      caddy.rate_limit_1.zone_8.key: "{header.Authorization}"
      caddy.rate_limit_1.zone_8.events: 1000
      caddy.rate_limit_1.zone_8.window: 1d
      caddy.rate_limit_1.zone_8.match.path: "*/event/get_data_for_encryption*"
      caddy.rate_limit_1.zone_8.match.method: GET

  caddy:
    build:
      context: .
      dockerfile: caddy/Dockerfile
    image: caddy-docker-proxy-rate-limit
    volumes:
      - ${DATA_DIR:-./data}/apikeys.caddy:/etc/caddy/apikeys
    entrypoint: /usr/bin/caddy
    command: docker-proxy run
    depends_on:
      compiler:
          condition: service_completed_successfully
